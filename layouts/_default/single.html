{{ define "main" }} {{/* <link rel="stylesheet" href="/css/blog.css" /> */}}
<!-- Use justify-center to center the group of items (TOC, Content, Spacer) -->
<div
  class="flex flex-row justify-center w-full mx-auto p-4 md:p-12 md:py-12 gap-8"
>
  <!-- æ–‡ç« å…§å®¹å€å¡Š -->
  <!-- max-w-3xl limits the width of the content itself -->
  <section class="max-w-3xl w-full">
    <div class="mb-8">
      <h1 class="text-4xl font-[700] mb-6 leading-relaxed">
        <span
          class="text-indigo-500 hover:text-indigo-300 transition-all duration-300 select-none"
          >$ </span
        >{{ .Title }}
      </h1>

      {{/* view count */}}
      <div class="flex items-center flex-wrap gap-2 text-gray-400">
        æœ¬æ–‡å·²è¢«ç€è¦½<span id="vercount_value_page_pv">Loading</span>æ¬¡
      </div>

      {{/* time and categories */}} {{ if or (eq .Section "blogs") (eq .Section
      "blog") (eq .Section "posts") (eq .Section "post") }}
      <div class="flex items-center flex-wrap gap-4 text-gray-400">
        {{ with .Date }} {{ $dateMachine := . | time.Format
        "2006-01-02T15:04:05-07:00" }} {{ $dateHuman := . | time.Format
        ":date_long" }}
        <time datetime="{{ $dateMachine }}">{{ $dateHuman }}</time>
        {{ end }}
      </div>
      {{ end }}

      <!-- categories -->
      {{ with .GetTerms "categories" }}
      <div class="flex items-center gap-2 text-sm mt-2">
        <span class="text-gray-400">{{ T "categories"}}:</span>
        <ul class="flex flex-wrap gap-2">
          {{ range . }}
          <li>
            <a
              href="{{ .RelPermalink }}"
              class="text-indigo-400 hover:text-indigo-300 transition-colors"
              >{{ .LinkTitle }}</a
            >
          </li>
          {{ end }}
        </ul>
      </div>
      {{ end }}

      <!-- æ‰‹æ©Ÿç‰ˆ TOC -->
      {{ if .TableOfContents }}
      <div class="lg:hidden mt-6">
        <details
          class="border border-gray-700 rounded-lg p-4 bg-[#1a1a1a] backdrop-blur-sm shadow-lg"
        >
          <summary
            class="cursor-pointer font-bold text-indigo-500 mb-2 flex items-center"
          >
            <svg
              class="w-5 h-5 mr-2"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 10h16M4 14h16M4 18h16"
              ></path>
            </svg>
            ğŸ“‹ æ–‡ç« ç›®éŒ„
          </summary>
          <div class="mt-3 mobile-toc">{{ .TableOfContents | safeHTML }}</div>
        </details>
      </div>
      {{ end }}
    </div>

    {{/* article content */}}
    <article class="prose prose-invert max-w-none mb-8">{{ .Content }}</article>

    {{/* tags */}}
    <aside class="mt-8">
      {{ with .GetTerms "tags" }}
      <h3 class="text-lg font-semibold mb-3">
        {{ (index . 0).Parent.LinkTitle | default "Tags" }}
      </h3>
      {{/* Use flex flex-row flex-wrap for row layout with wrapping and gap-2
      for spacing */}}
      <ul class="flex flex-row flex-wrap items-start gap-2">
        {{ range . }}
        <li>
          <a
            href="{{ .RelPermalink }}"
            class="inline-block px-2 py-1 text-xs bg-[#121212] text-gray-100 border border-gray-800 rounded-md transition-all duration-300 hover:bg-indigo-500"
            >{{ .LinkTitle }}</a
          >
        </li>
        {{ end }}
      </ul>
      {{ end }}
    </aside>

    <!-- æ·»åŠ ç•™è¨€æ¿ -->
    <div class="mt-12">
      <h2 class="text-3xl font-bold mb-6">{{ T "comments" }}</h2>
      {{ partial "comments.html" . }}
    </div>
  </section>
  <!-- TOC å´é‚Šæ¬„ (éš±è—åœ¨å°è¢å¹•) -->
  {{ if .TableOfContents }}
  <aside class="hidden lg:block w-64 flex-shrink-0">
    {{ partial "toc.html" . }}
  </aside>
  {{ end }}
</div>

<!-- TOC scripts -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const tocLinks = document.querySelectorAll("#toc-nav a");
    // åˆå§‹åŒ–æ‰€æœ‰éŒ¨é» classï¼Œä¸¦åŠ ä¸Š hover æ•ˆæœ
    tocLinks.forEach((link) => {
      link.classList.add(
        "transition-all",
        "duration-300",
        "hover:text-indigo-300"
      );
    });

    // æ¨™è¨˜æœ‰å­é …ç›®çš„ li å…ƒç´ 
    document.querySelectorAll("#toc-nav li").forEach((li) => {
      const hasChildren = li.querySelector("ul, ol");
      if (hasChildren) {
        li.classList.add("has-children");
      }
    });

    const headingIds = Array.from(tocLinks).map((link) =>
      decodeURIComponent(link.getAttribute("href").slice(1))
    );
    const headings = headingIds
      .map((id) => document.getElementById(id))
      .filter(Boolean);

    // å»ºç«‹æ¨™é¡Œå±¤ç´šå°æ‡‰
    const headingLevels = headings.map((heading) =>
      parseInt(heading.tagName.slice(1))
    );

    function updateTocExpansion(activeIndex) {
      // é‡ç½®æ‰€æœ‰ active ç‹€æ…‹
      document
        .querySelectorAll("#toc-nav li")
        .forEach((li) => li.classList.remove("active"));

      if (activeIndex >= 0) {
        const activeLink = tocLinks[activeIndex];
        const activeLi = activeLink.closest("li");

        // æ¨™è¨˜ç•¶å‰æ´»å‹•é …ç›®
        activeLi.classList.add("active");

        // å‘ä¸Šéæ­¸å±•é–‹æ‰€æœ‰çˆ¶å±¤ç´š
        let parentLi = activeLi.parentElement.closest("li");
        while (parentLi) {
          parentLi.classList.add("active");
          parentLi = parentLi.parentElement.closest("li");
        }

        // å¦‚æœç•¶å‰æ¨™é¡Œæœ‰å­æ¨™é¡Œï¼Œä¹Ÿå±•é–‹å®ƒå€‘
        const currentLevel = headingLevels[activeIndex];
        for (let i = activeIndex + 1; i < headings.length; i++) {
          const nextLevel = headingLevels[i];
          if (nextLevel <= currentLevel) break;

          // å¦‚æœæ˜¯ç›´æ¥å­æ¨™é¡Œï¼ˆä¸‹ä¸€å±¤ç´šï¼‰ï¼Œå±•é–‹å®ƒ
          if (nextLevel === currentLevel + 1) {
            const nextLi = tocLinks[i]
              .closest("li")
              .parentElement.closest("li");
            if (nextLi) nextLi.classList.add("active");
          }
        }
      }
    }

    function onScroll() {
      let activeIndex = -1;
      const scrollPosition = window.scrollY + 150; // å¢åŠ åç§»é‡è®“åˆ‡æ›æ›´è‡ªç„¶

      for (let i = 0; i < headings.length; i++) {
        if (scrollPosition >= headings[i].offsetTop) {
          activeIndex = i;
        }
      }

      // æ›´æ–°ç›®éŒ„å±•é–‹ç‹€æ…‹
      updateTocExpansion(activeIndex);

      // æ›´æ–°é€£çµæ¨£å¼
      tocLinks.forEach((link, i) => {
        if (i === activeIndex) {
          link.classList.add("text-indigo-400", "font-bold");
          link.classList.remove("text-gray-300");
        } else {
          link.classList.remove("text-indigo-400", "font-bold");
          link.classList.add("text-gray-300");
        }
      });
    }

    window.addEventListener("scroll", onScroll, { passive: true });
    onScroll(); // åˆå§‹åŒ–
  });
</script>

<style>
  article {
    max-width: 100%;
  }
  article ol,
  article ul {
    margin: 1.5rem 0 1.5rem 1.75rem;
    padding-left: 0.5rem;
  }
  article li {
    margin-bottom: 0.75rem;
    list-style-position: outside;
    padding-left: 0.5rem;
    line-height: 1.6;
  }
  article li::marker {
    color: #6366f1;
    font-weight: bold;
  }
  article ol li {
    list-style-type: decimal;
  }
  article ul li {
    list-style-type: disc;
  }
  article ol li ol,
  article ul li ul,
  article ul li ol,
  article ol li ul {
    margin-top: 1rem;
  }
  article ul li ul li {
    list-style-type: circle;
  }
  article ol li ol li {
    list-style-type: lower-alpha;
  }
  article li:hover::marker {
    color: #a5b4fc;
    transition: color 0.3s ease-in-out;
  }
  article p {
    margin: 1rem 0;
    line-height: 1.6;
  }
  article table {
    margin: 1.5rem 0;
    width: 100%;
    border-radius: 8px;
    border-collapse: collapse;
  }
  article table th,
  article table td {
    padding: 0.75rem;
    border: 1px solid #919191;
    text-align: left;
  }
  article table th {
    background-color: #0e0e21;
    color: #fff;
  }
  article table tr:nth-child(even) {
    background-color: #1b1b36;
  }
  article table tr:nth-child(odd) {
    background-color: rgb(26, 26, 53);
  }
  article table tr:hover {
    background-color: #252661;
    transition: 0.3s;
  }
  /* Checkbox styling in Markdown content */
  article input[type="checkbox"] {
    appearance: none;
    -webkit-appearance: none;
    width: 1.25em;
    height: 1.25em;
    border: 1px solid #6366f1;
    border-radius: 4px;
    vertical-align: middle;
    margin-right: 0.5em;
    position: relative;
    background-color: #121212;
  }

  article input[type="checkbox"]:checked {
    background-color: #6366f1;
    border-color: #6366f1;
  }

  article input[type="checkbox"]:checked::after {
    content: "âœ“";
    position: absolute;
    color: white;
    font-size: 0.9em;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  article ul li:has(input[type="checkbox"]) {
    list-style-type: none;
    margin-left: -1.5rem;
  }

  /*  custom-heading  */
  .custom-heading {
    position: relative;
    font-weight: 600;
    padding-bottom: 0.5rem;
  }
  .custom-heading-1 {
    font-size: 1.8rem;
    font-weight: 800;
  }
  .custom-heading-2 {
    font-size: 1.65rem;
    font-weight: 700;
  }
  .custom-heading-3 {
    font-size: 1.45rem;
  }
  .custom-heading-4 {
    font-size: 1.35rem;
  }
  .custom-heading-5 {
    font-size: 1.3rem;
  }
  .custom-heading-6 {
    font-size: 1.25rem;
  }
  /* Hide anchor by default */
  .anchor {
    opacity: 0;
    transition: opacity 0.2s ease;
  }
  /* Show anchor on heading hover */
  .custom-heading:hover .anchor {
    opacity: 1;
  }

  /* æ‰‹æ©Ÿç‰ˆç›®éŒ„æ¨£å¼ */
  .mobile-toc ul,
  .mobile-toc ol {
    list-style: none;
    padding-left: 0;
    margin: 0;
  }

  .mobile-toc ul ul,
  .mobile-toc ol ol {
    padding-left: 1rem;
    margin-top: 0.25rem;
  }

  .mobile-toc li {
    margin: 0.5rem 0;
  }

  .mobile-toc a {
    display: block;
    padding: 0.5rem 0.75rem;
    color: #9ca3af;
    text-decoration: none;
    border-radius: 0.5rem;
    transition: all 0.3s ease;
    border-left: 3px solid transparent;
  }

  .mobile-toc a:hover {
    background-color: rgba(99, 102, 241, 0.1);
    color: #a5b4fc;
    border-left-color: #6366f1;
  }
</style>

{{ end }}
